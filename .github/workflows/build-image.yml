name: Build and Push Image

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Upstream release tag (optional)"
        required: false
        type: string
      force:
        description: "Build even if tag already exists or master is not synced"
        required: false
        default: false
        type: boolean
  schedule:
    - cron: "30 */6 * * *"
  workflow_run:
    workflows: ["Sync Upstream"]
    types: [completed]

concurrency:
  group: build-image
  cancel-in-progress: false

permissions:
  contents: read

env:
  IMAGE_NAME: digikwal/opencart
  UPSTREAM_REPO: opencart/opencart

jobs:
  build:
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout docker branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.tag }}" ]; then
            tag="${{ inputs.tag }}"
          else
            tag=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/repos/${UPSTREAM_REPO}/releases/latest" | jq -r .tag_name)
          fi

          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Failed to determine upstream release tag."
            exit 1
          fi

          echo "tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Check gating conditions
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ "${{ inputs.force }}" = "true" ]; then
            echo "build=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          upstream_sha=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/commits/master" | jq -r .sha)
          fork_sha=$(curl -fsSL -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/master" | jq -r .sha)

          if [ -z "$upstream_sha" ] || [ -z "$fork_sha" ] || [ "$upstream_sha" = "null" ] || [ "$fork_sha" = "null" ]; then
            echo "Unable to resolve master SHAs."
            echo "build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$upstream_sha" != "$fork_sha" ]; then
            echo "Master is not synced with upstream; skipping build."
            echo "build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          tag="${{ steps.release.outputs.tag }}"
          if curl -fsSL "https://hub.docker.com/v2/repositories/${IMAGE_NAME}/tags/${tag}/" >/dev/null; then
            echo "Tag ${tag} already exists on Docker Hub; skipping build."
            echo "build=false" >> "$GITHUB_OUTPUT"
          else
            echo "build=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout upstream release
        if: steps.gate.outputs.build == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ steps.release.outputs.tag }}
          path: upstream

      - name: Prepare build context
        if: steps.gate.outputs.build == 'true'
        run: |
          set -euo pipefail
          rm -rf upstream/docker
          cp -R docker upstream/docker
          cp .dockerignore upstream/.dockerignore

      - name: Set up QEMU
        if: steps.gate.outputs.build == 'true'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.gate.outputs.build == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: steps.gate.outputs.build == 'true'
        uses: docker/login-action@v3
        with:
          username: digikwal
          password: ${{ secrets.DIGIKWAL_OPENCART }}

      - name: Build and push image
        if: steps.gate.outputs.build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./upstream
          file: ./upstream/docker/runtime/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.release.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest
